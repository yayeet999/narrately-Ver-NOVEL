<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Customization</title>

    <!-- Include jQuery first -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Then include Select2 CSS and JS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Custom Styles -->
    <style>
        /* Basic Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Body and Container Styling */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Controls Container */
        .controls-container {
            width: 100%;
            max-width: 800px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 40px;
        }

        h3, h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        select, input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
        }

        /* Toggle Sections */
        .toggle-section {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            background-color: #f1f3f4;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease;
        }

        .toggle-section:hover {
            background-color: #e2e6ea;
        }

        .toggle-content {
            display: none;
            padding: 10px 0;
            margin-bottom: 15px;
        }

        /* Create Story Button */
        #createStoryButton {
            width: 100%;
            padding: 15px;
            background-color: #28a745;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #createStoryButton:hover {
            background-color: #218838;
        }

        /* Story Output Section - Completely Natural Layout */
        #storyOutput {
            width: 100%;
            max-width: 1000px; /* Wider than controls */
            margin: 0 auto;
            padding: 0;
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            background: none;
            border: none;
            box-shadow: none;
            text-align: left;
        }

        /* Copy Button */
        .copy-story-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        .copy-story-btn:hover {
            background-color: #218838;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            #storyOutput {
                padding: 0 20px;
                font-size: 17px;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            #storyOutput {
                padding: 0 15px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h3>Story Customization</h3>
        <!-- Basic Story Settings -->
        <!-- Narrative Style -->
        <label for="narrative-style">Narrative Style</label>
        <select id="narrative-style">
            <option value="">Let Narrately Decide</option>
            <option value="descriptive">Descriptive and Immersive</option>
            <option value="straightforward">Straightforward and Direct</option>
            <option value="poetic">Poetic and Lyrical</option>
            <option value="dialog-driven">Dialog Driven</option>
            <option value="reflective">Reflective and Introspective</option>
        </select>

        <!-- Story Perspective -->
        <label for="story-perspective">Story Perspective</label>
        <select id="story-perspective">
            <option value="">Let Narrately Decide</option>
            <option value="third-person-general">Third Person General</option>
            <option value="third-person-limited">Third Person Limited</option>
            <option value="second-person">Second Person</option>
            <option value="first-person">First Person</option>
        </select>

        <!-- Audience Type -->
        <label for="audience-type">Audience Type</label>
        <select id="audience-type">
            <option value="">Let Narrately Decide</option>
            <option value="general">General Audience (All Ages)</option>
            <option value="young-adults">Young Adults (13-17)</option>
            <option value="adults">Adults (17+)</option>
        </select>

        <!-- Main Genre -->
        <label for="main-genre">Main Genre</label>
        <select id="main-genre">
            <option value="">Let Narrately Decide</option>
            <option value="western">Western - Frontier</option>
            <option value="modern">Modern - Contemporary</option>
            <option value="horror">Horror - Scary & Suspense</option>
            <option value="mystery">Mystery - Puzzle Solving</option>
            <option value="romance">Romance - Love & Relationships</option>
            <option value="sci-fi">Science Fiction - Futuristic</option>
            <option value="fantasy">Fantasy - Magical worlds & creatures</option>
            <option value="thriller">Thriller - High Stakes & Tension</option>
            <option value="historical">Historical - Based on history</option>
            <option value="biography">Biography - Life Story</option>
            <option value="adventure">Adventure - Exciting Journeys</option>
            <option value="action">Action - Physical & Fast-paced</option>
            <option value="superhero">Superhero - Powered Characters</option>
            <option value="drama">Drama - Emotional & Relational</option>
            <option value="comedy">Comedy - Humorous & Light-hearted</option>
            <option value="crime">Crime - Criminal Activities</option>
            <option value="political">Political - Governance & Power</option>
            <option value="cyberpunk">Cyberpunk - High-tech & Low-life</option>
            <option value="post-apocalyptic">Post-Apocalyptic - Aftermath Scenarios</option>
            <option value="steampunk">Steampunk - Victorian Tech Fusion</option>
            <option value="urban-fantasy">Urban Fantasy - Magical in Modern Cities</option>
        </select>

        <!-- Sub Genre -->
        <label for="sub-genre">Sub Genre</label>
        <select id="sub-genre">
            <option value="">Let Narrately Decide</option>
            <option value="gothic-horror">Gothic Horror - Dark & eerie</option>
            <option value="supernatural">Supernatural - Beyond natural laws</option>
            <option value="psychological">Psychological - Mind & Behavior</option>
            <option value="slasher">Slasher - Serial Killers</option>
            <option value="paranormal">Paranormal - Ghosts & Spirits</option>
            <option value="lovecraftian">Lovecraftian - Cosmic Horror</option>
            <option value="body-horror">Body Horror - Disturbing Transformations</option>
            <option value="found-footage">Found Footage - Documentary-style Horror</option>
            <option value="terror">Terror - Intense Fear</option>
            <option value="survival">Survival - Overcoming life-threatening challenges</option>
            <option value="sword-and-sorcery">Sword & Sorcery - Magic & warriors</option>
            <option value="dark-fantasy">Dark Fantasy - Grim & Gritty</option>
            <option value="epic-fantasy">Epic Fantasy - Grand Scale & World-building</option>
            <option value="urban-fantasy">Urban Fantasy - Magical in Modern Cities</option>
            <option value="high-fantasy">High Fantasy - Completely Imaginary Worlds</option>
            <option value="low-fantasy">Low Fantasy - Magical elements in Realistic Settings</option>
            <option value="heroic-fantasy">Heroic Fantasy - Hero-centric Stories</option>
            <option value="grimdark">Grimdark - Bleak & Gritty</option>
            <option value="fairy-tale">Fairy Tale - Mythical & Moral Stories</option>
            <option value="steampunk">Steampunk - Victorian Tech Fusion</option>
            <option value="magical-realism">Magical Realism - Magical Elements in Real World</option>
        </select>

        <!-- World Type -->
        <label for="world-type">World Type</label>
        <select id="world-type">
            <option value="">Let Narrately Decide</option>
            <option value="mythical">Mythical - Gods & legends</option>
            <option value="futuristic">Futuristic - Advanced Technology</option>
            <option value="dystopian">Dystopian - Oppressive Societies</option>
            <option value="utopian">Utopian - Ideal Societies</option>
            <option value="alternate-reality">Alternate Reality - Divergent Histories</option>
            <option value="post-apocalyptic">Post-Apocalyptic - Aftermath Scenarios</option>
            <option value="steampunk">Steampunk - Victorian Tech Fusion</option>
            <option value="cyberpunk">Cyberpunk - High-tech & Low-life</option>
            <option value="space-faring">Space-faring - Interstellar Societies</option>
            <option value="virtual-world">Virtual World - Digital Realms</option>
            <option value="prehistoric">Prehistoric - Ancient Times</option>
            <option value="medieval">Medieval - Middle Ages Setting</option>
            <option value="modern">Modern - Contemporary World</option>
            <option value="historical">Historical - Based on Real History</option>
            <option value="magical">Magical - Enchanted & Spellbound</option>
            <option value="alien-world">Alien World - Extraterrestrial Settings</option>
            <option value="underwater">Underwater - Submarine Societies</option>
            <option value="subterranean">Subterranean - Underground Realms</option>
            <option value="multiverse">Multiverse - Multiple Parallel Universes</option>
            <option value="time-travel">Time Travel - Journeys Through Time</option>
        </select>

        <!-- World View -->
        <label for="world-view">World View</label>
        <select id="world-view">
            <option value="">Let Narrately Decide</option>
            <option value="surreal">Surreal - Dreamlike</option>
            <option value="realistic">Realistic - True to Life</option>
            <option value="fantastical">Fantastical - Highly Imaginative</option>
            <option value="grimdark">Grimdark - Bleak & Gritty</option>
            <option value="romantic">Romantic - Emphasizing Emotion</option>
            <option value="minimalist">Minimalist - Simple & Clean</option>
            <option value="ornate">Ornate - Elaborate & Detailed</option>
            <option value="abstract">Abstract - Conceptual & Non-representational</option>
            <option value="vibrant">Vibrant - Bright & Colorful</option>
            <option value="muted">Muted - Subdued Colors</option>
            <option value="dark">Dark - Ominous & Shadowy</option>
            <option value="light">Light - Airy & Bright</option>
            <option value="gothic">Gothic - Dark & Mysterious</option>
            <option value="whimsical">Whimsical - Playful & Quirky</option>
            <option value="epic">Epic - Grand & Majestic</option>
            <option value="chaotic">Chaotic - Disorderly & Unpredictable</option>
            <option value="orderly">Orderly - Structured & Organized</option>
            <option value="ethereal">Ethereal - Delicate & Otherworldly</option>
            <option value="gritty">Gritty - Raw & Unpolished</option>
            <option value="nostalgic">Nostalgic - Sentimental & Reflective</option>
        </select>

        <!-- Time Period -->
        <label for="time-period">Time Period</label>
        <select id="time-period">
            <option value="">Let Narrately Decide</option>
            <option value="prehistoric">Prehistoric - Ancient Times</option>
            <option value="ancient">Ancient - Ancient Civilizations</option>
            <option value="medieval">Medieval - Middle Ages</option>
            <option value="renaissance">Renaissance - 14th to 17th Century</option>
            <option value="industrial">Industrial - Industrial Revolution</option>
            <option value="victorian">Victorian - 19th Century</option>
            <option value="modern">Modern - Contemporary</option>
            <option value="future">Future - Advanced Future</option>
            <option value="post-apocalyptic">Post-Apocalyptic - Aftermath Scenarios</option>
            <option value="steampunk">Steampunk - Victorian Tech Fusion</option>
            <option value="cyberpunk">Cyberpunk - High-tech & Low-life</option>
            <option value="alternate-reality">Alternate Reality - Divergent Histories</option>
            <option value="time-travel">Time Travel - Journeys Through Time</option>
            <option value="space-faring">Space-faring - Interstellar Societies</option>
            <option value="virtual-world">Virtual World - Digital Realms</option>
        </select>

        <!-- Character 1 -->
        <div class="toggle-section" onclick="toggleVisibility('character1')">
            Character 1 <span class="expand-icon">+</span>
        </div>
        <div id="character1" class="toggle-content">
            <!-- Character Name -->
            <label for="char1-name">Name</label>
            <input type="text" id="char1-name" placeholder="Enter character name">

            <!-- Character Gender -->
            <label for="char1-gender">Gender</label>
            <select id="char1-gender">
                <option value="">Let Narrately Decide</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="non-binary">Non-Binary</option>
            </select>

            <!-- Character Age Range -->
            <label for="char1-age">Age Range</label>
            <select id="char1-age">
                <option value="">Let Narrately Decide</option>
                <option value="childhood">Childhood (Ages 0-12)</option>
                <option value="teenage">Teenage Years (Ages 13-17)</option>
                <option value="young-adult">Young Adult (Ages 18-25)</option>
                <option value="early-adulthood">Early Adulthood (Ages 26-35)</option>
                <option value="mid-adulthood">Mid Adulthood (Ages 36-50)</option>
                <option value="late-adulthood">Late Adulthood (Ages 51-65)</option>
                <option value="senior">Senior Age (Ages 66+)</option>
            </select>

            <!-- Character Role -->
            <label for="char1-role">Character Role</label>
            <select id="char1-role">
                <option value="">Let Narrately Decide</option>
                <option value="minor-character">Minor Character</option>
                <option value="supporting-character">Supporting Character</option>
                <option value="antagonist">Main Antagonist</option>
                <option value="protagonist">Main Protagonist</option>
            </select>

            <!-- Backstory -->
            <label for="char1-backstory">Backstory</label>
            <textarea id="char1-backstory" rows="3" placeholder="Enter backstory..."></textarea>

            <!-- Strengths -->
            <label for="char1-strengths">Strengths</label>
            <textarea id="char1-strengths" rows="2" placeholder="Enter strengths..."></textarea>

            <!-- Weaknesses / Flaws -->
            <label for="char1-weaknesses">Weaknesses / Flaws</label>
            <textarea id="char1-weaknesses" rows="2" placeholder="Enter weaknesses or flaws..."></textarea>

            <!-- Personality -->
            <label for="char1-personality">Personality</label>
            <textarea id="char1-personality" rows="2" placeholder="Enter personality traits..."></textarea>

            <!-- Morality Slider -->
            <div class="slider-container">
                <label for="char1-morality">Morality</label>
                <input type="range" id="char1-morality" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Purely Evil</span>
                    <span>Mostly Corrupt</span>
                    <span>Morally Neutral</span>
                    <span>Mostly Good</span>
                    <span>Purely Virtuous</span>
                </div>
            </div>

            <!-- Confidence Slider -->
            <div class="slider-container">
                <label for="char1-confidence">Confidence</label>
                <input type="range" id="char1-confidence" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Very Insecure</span>
                    <span>Somewhat Insecure</span>
                    <span>Moderately Confident</span>
                    <span>Mostly Assured</span>
                    <span>Highly Confident</span>
                </div>
            </div>

            <!-- Decision-Making Slider -->
            <div class="slider-container">
                <label for="char1-decision-making">Decision-Making</label>
                <input type="range" id="char1-decision-making" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Indecisive</span>
                    <span>Cautious Planning</span>
                    <span>Balanced Judgement</span>
                    <span>Quick Decisions</span>
                    <span>Impulsive Choices</span>
                </div>
            </div>

            <!-- Predictability Slider -->
            <div class="slider-container">
                <label for="char1-predictability">Predictability</label>
                <input type="range" id="char1-predictability" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Chaotic</span>
                    <span>Unpredictable</span>
                    <span>Occasionally Surprising</span>
                    <span>Mostly Consistent</span>
                    <span>Highly Predictable</span>
                </div>
            </div>

            <!-- Relationships to Other Characters -->
            <label for="char1-relationships">Relationships to Other Characters</label>
            <textarea id="char1-relationships" rows="2" placeholder="Enter character relationships..."></textarea>
        </div>

        <!-- Character 2 -->
        <div class="toggle-section" onclick="toggleVisibility('character2')">
            Add Character 2? <span class="expand-icon">+</span>
        </div>
        <div id="character2" class="toggle-content">
            <!-- Character Name -->
            <label for="char2-name">Name</label>
            <input type="text" id="char2-name" placeholder="Enter character name">

            <!-- Character Gender -->
            <label for="char2-gender">Gender</label>
            <select id="char2-gender">
                <option value="">Let Narrately Decide</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="non-binary">Non-Binary</option>
            </select>

            <!-- Character Age Range -->
            <label for="char2-age">Age Range</label>
            <select id="char2-age">
                <option value="">Let Narrately Decide</option>
                <option value="childhood">Childhood (Ages 0-12)</option>
                <option value="teenage">Teenage Years (Ages 13-17)</option>
                <option value="young-adult">Young Adult (Ages 18-25)</option>
                <option value="early-adulthood">Early Adulthood (Ages 26-35)</option>
                <option value="mid-adulthood">Mid Adulthood (Ages 36-50)</option>
                <option value="late-adulthood">Late Adulthood (Ages 51-65)</option>
                <option value="senior">Senior Age (Ages 66+)</option>
            </select>
            <!-- Character 2 Role -->
            <label for="char2-role">Character Role</label>
            <select id="char2-role">
                <option value="">Let Narrately Decide</option>
                <option value="minor-character">Minor Character</option>
                <option value="supporting-character">Supporting Character</option>
                <option value="antagonist">Main Antagonist</option>
                <option value="protagonist">Main Protagonist</option>
            </select>

            <!-- Backstory -->
            <label for="char2-backstory">Backstory</label>
            <textarea id="char2-backstory" rows="3" placeholder="Enter backstory..."></textarea>

            <!-- Strengths -->
            <label for="char2-strengths">Strengths</label>
            <textarea id="char2-strengths" rows="2" placeholder="Enter strengths..."></textarea>

            <!-- Weaknesses / Flaws -->
            <label for="char2-weaknesses">Weaknesses / Flaws</label>
            <textarea id="char2-weaknesses" rows="2" placeholder="Enter weaknesses or flaws..."></textarea>

            <!-- Personality -->
            <label for="char2-personality">Personality</label>
            <textarea id="char2-personality" rows="2" placeholder="Enter personality traits..."></textarea>

            <!-- Morality Slider -->
            <div class="slider-container">
                <label for="char2-morality">Morality</label>
                <input type="range" id="char2-morality" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Purely Evil</span>
                    <span>Mostly Corrupt</span>
                    <span>Morally Neutral</span>
                    <span>Mostly Good</span>
                    <span>Purely Virtuous</span>
                </div>
            </div>

            <!-- Confidence Slider -->
            <div class="slider-container">
                <label for="char2-confidence">Confidence</label>
                <input type="range" id="char2-confidence" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Very Insecure</span>
                    <span>Somewhat Insecure</span>
                    <span>Moderately Confident</span>
                    <span>Mostly Assured</span>
                    <span>Highly Confident</span>
                </div>
            </div>

            <!-- Decision-Making Slider -->
            <div class="slider-container">
                <label for="char2-decision-making">Decision-Making</label>
                <input type="range" id="char2-decision-making" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Indecisive</span>
                    <span>Cautious Planning</span>
                    <span>Balanced Judgement</span>
                    <span>Quick Decisions</span>
                    <span>Impulsive Choices</span>
                </div>
            </div>

            <!-- Predictability Slider -->
            <div class="slider-container">
                <label for="char2-predictability">Predictability</label>
                <input type="range" id="char2-predictability" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Chaotic</span>
                    <span>Unpredictable</span>
                    <span>Occasionally Surprising</span>
                    <span>Mostly Consistent</span>
                    <span>Highly Predictable</span>
                </div>
            </div>

            <!-- Relationships to Other Characters -->
            <label for="char2-relationships">Relationships to Other Characters</label>
            <textarea id="char2-relationships" rows="2" placeholder="Enter character relationships..."></textarea>
        </div>

        <!-- Character 3 -->
        <div class="toggle-section" onclick="toggleVisibility('character3')">
            Add Character 3? <span class="expand-icon">+</span>
        </div>
        <div id="character3" class="toggle-content">
            <!-- Character Name -->
            <label for="char3-name">Name</label>
            <input type="text" id="char3-name" placeholder="Enter character name">

            <!-- Character Gender -->
            <label for="char3-gender">Gender</label>
            <select id="char3-gender">
                <option value="">Let Narrately Decide</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="non-binary">Non-Binary</option>
            </select>

            <!-- Character Age Range -->
            <label for="char3-age">Age Range</label>
            <select id="char3-age">
                <option value="">Let Narrately Decide</option>
                <option value="childhood">Childhood (Ages 0-12)</option>
                <option value="teenage">Teenage Years (Ages 13-17)</option>
                <option value="young-adult">Young Adult (Ages 18-25)</option>
                <option value="early-adulthood">Early Adulthood (Ages 26-35)</option>
                <option value="mid-adulthood">Mid Adulthood (Ages 36-50)</option>
                <option value="late-adulthood">Late Adulthood (Ages 51-65)</option>
                <option value="senior">Senior Age (Ages 66+)</option>
            </select>

            <!-- Rest of Character 3 fields... -->
            <!-- Character 3 Role -->
            <label for="char3-role">Character Role</label>
            <select id="char3-role">
                <option value="">Let Narrately Decide</option>
                <option value="minor-character">Minor Character</option>
                <option value="supporting-character">Supporting Character</option>
                <option value="antagonist">Main Antagonist</option>
                <option value="protagonist">Main Protagonist</option>
            </select>

            <!-- Backstory -->
            <label for="char3-backstory">Backstory</label>
            <textarea id="char3-backstory" rows="3" placeholder="Enter backstory..."></textarea>

            <!-- Strengths -->
            <label for="char3-strengths">Strengths</label>
            <textarea id="char3-strengths" rows="2" placeholder="Enter strengths..."></textarea>

            <!-- Weaknesses / Flaws -->
            <label for="char3-weaknesses">Weaknesses / Flaws</label>
            <textarea id="char3-weaknesses" rows="2" placeholder="Enter weaknesses or flaws..."></textarea>

            <!-- Personality -->
            <label for="char3-personality">Personality</label>
            <textarea id="char3-personality" rows="2" placeholder="Enter personality traits..."></textarea>

            <!-- Morality Slider -->
            <div class="slider-container">
                <label for="char3-morality">Morality</label>
                <input type="range" id="char3-morality" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Purely Evil</span>
                    <span>Mostly Corrupt</span>
                    <span>Morally Neutral</span>
                    <span>Mostly Good</span>
                    <span>Purely Virtuous</span>
                </div>
            </div>

            <!-- Confidence Slider -->
            <div class="slider-container">
                <label for="char3-confidence">Confidence</label>
                <input type="range" id="char3-confidence" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Very Insecure</span>
                    <span>Somewhat Insecure</span>
                    <span>Moderately Confident</span>
                    <span>Mostly Assured</span>
                    <span>Highly Confident</span>
                </div>
            </div>

            <!-- Decision-Making Slider -->
            <div class="slider-container">
                <label for="char3-decision-making">Decision-Making</label>
                <input type="range" id="char3-decision-making" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Indecisive</span>
                    <span>Cautious Planning</span>
                    <span>Balanced Judgement</span>
                    <span>Quick Decisions</span>
                    <span>Impulsive Choices</span>
                </div>
            </div>

            <!-- Predictability Slider -->
            <div class="slider-container">
                <label for="char3-predictability">Predictability</label>
                <input type="range" id="char3-predictability" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Chaotic</span>
                    <span>Unpredictable</span>
                    <span>Occasionally Surprising</span>
                    <span>Mostly Consistent</span>
                    <span>Highly Predictable</span>
                </div>
            </div>

            <!-- Relationships to Other Characters -->
            <label for="char3-relationships">Relationships to Other Characters</label>
            <textarea id="char3-relationships" rows="2" placeholder="Enter character relationships..."></textarea>
        </div>

        <!-- Advanced Settings Section -->
        <div class="toggle-section" onclick="toggleVisibility('advanced-settings')">
            Advanced Settings <span class="expand-icon">+</span>
        </div>
        <div id="advanced-settings" class="toggle-content">
            <!-- Story Plot Description -->
            <label for="story-plot">Story Plot Description</label>
            <textarea id="story-plot" rows="3" placeholder="Describe the general story plot..."></textarea>

            <!-- Opening Scene Context -->
            <label for="opening-scene">Opening Scene Context</label>
            <textarea id="opening-scene" rows="3" placeholder="Describe the opening scene..."></textarea>

            <!-- Story Pacing Slider -->
            <div class="slider-container">
                <label for="story-pacing">Story Pacing</label>
                <input type="range" id="story-pacing" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Leisurely Unfolding</span>
                    <span>Slow and Detailed</span>
                    <span>Moderate Progression</span>
                    <span>Steady and Consistent</span>
                    <span>Fast and Intense</span>
                </div>
            </div>

            <!-- Plot Complexity Slider -->
            <div class="slider-container">
                <label for="plot-complexity">Plot Complexity</label>
                <input type="range" id="plot-complexity" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Simple and Straightforward</span>
                    <span>Mostly Linear</span>
                    <span>Moderately Layered</span>
                    <span>Intricate and Nuanced</span>
                    <span>Highly Complex</span>
                </div>
            </div>

            <!-- Plot Predictability Slider -->
            <div class="slider-container">
                <label for="plot-predictability">Plot Predictability</label>
                <input type="range" id="plot-predictability" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Highly Predictable</span>
                    <span>Mostly Expected</span>
                    <span>Moderately Surprising</span>
                    <span>Unpredictable Twists</span>
                    <span>Completely Unpredictable</span>
                </div>
            </div>
            <!-- Main Story Theme (Multi-Select Dropdown) -->
            <label for="main-story-theme">Main Story Theme(s)</label>
            <select id="main-story-theme" name="main-story-theme[]" multiple="multiple" style="width: 100%;">
                <option value="revenge">Revenge – Retribution for a past wrong</option>
                <option value="destiny">Destiny – Preordained fate or path</option>
                <option value="identity">Identity – Exploration of self or identity</option>
                <option value="sacrifice">Sacrifice – Giving up something valuable</option>
                <option value="courage">Courage – Bravery in the face of fear</option>
                <option value="justice">Justice – Righting wrongs or seeking fairness</option>
                <option value="freedom">Freedom – Escape from oppression or constraint</option>
                <option value="power">Power – Struggles for control or dominance</option>
                <option value="survival">Survival – Overcoming life-threatening challenges</option>
                <option value="transformation">Transformation – Personal growth and change</option>
                <option value="adventure">Adventure – Exciting and risky journey</option>
                <option value="good-vs-evil">Good vs. Evil – Moral struggle between opposites</option>
                <option value="betrayal">Betrayal – Trust broken by disloyalty</option>
                <option value="love">Love – Romantic or familial affection</option>
                <option value="redemption">Redemption – Seeking forgiveness and renewal</option>
            </select>

            <!-- Sub Story Theme (Multi-Select Dropdown) -->
            <label for="sub-story-theme">Sub Story Theme(s)</label>
            <select id="sub-story-theme" name="sub-story-theme[]" multiple="multiple" style="width: 100%;">
                <option value="mystery">Mystery – Unraveling puzzles or unknowns</option>
                <option value="isolation">Isolation – Loneliness or being cut off</option>
                <option value="ambition">Ambition – Pursuit of goals or power</option>
                <option value="family">Family – Dynamics of familial relationships</option>
                <option value="betrayal">Betrayal – Disloyalty within relationships</option>
                <option value="loss">Loss – Dealing with grief or absence</option>
                <option value="hope">Hope – Optimism for the future</option>
                <option value="chaos">Chaos – Disruption and disorder</option>
                <option value="revenge">Revenge – Desire for payback</option>
                <option value="friendship">Friendship – Bond between companions</option>
            </select>

            <!-- Additional Settings -->
            <div class="slider-container">
                <label for="additional-characters">Additional Characters</label>
                <input type="range" id="additional-characters" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Few Supporting Characters</span>
                    <span>Moderate Characters Presence</span>
                    <span>Balanced Character Inclusion</span>
                    <span>Frequent Character Interactions</span>
                    <span>Crowded with Characters</span>
                </div>
            </div>

            <div class="slider-container">
                <label for="character-growth">Character Growth</label>
                <input type="range" id="character-growth" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>No Character Development</span>
                    <span>Minimal Personal Growth</span>
                    <span>Moderate Change Arc</span>
                    <span>Significant Transformation</span>
                    <span>Complete Character Overhaul</span>
                </div>
            </div>

            <div class="slider-container">
                <label for="dialogue-density">Dialogue Density</label>
                <input type="range" id="dialogue-density" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Minimal Dialogue</span>
                    <span>Sporadic Conversations</span>
                    <span>Balanced Dialogue</span>
                    <span>Frequent Discussions</span>
                    <span>Dialogue Heavy</span>
                </div>
            </div>

            <div class="slider-container">
                <label for="emotional-depth">Emotional Depth</label>
                <input type="range" id="emotional-depth" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Surface Level Emotions</span>
                    <span>Mild Emotional Tone</span>
                    <span>Balanced Emotional Range</span>
                    <span>Deep Emotional Moments</span>
                    <span>Intensely Emotional</span>
                </div>
            </div>

            <!-- Mood and Feel -->
            <label for="mood-feel">Mood and Feel</label>
            <select id="mood-feel">
                <option value="">Let Narrately Decide</option>
                <option value="ironic-despair">Ironic Despair – Hopelessness mixed with dark humor</option>
                <option value="subtle-menace">Subtle Menace – Quietly threatening</option>
                <option value="mechanical-coldness">Mechanical Coldness – Calculated, robotic</option>
                <option value="raging-tranquility">Raging Tranquility – Calm surface, storm beneath</option>
                <option value="surreal">Surreal – Dreamlike, strange</option>
                <option value="nostalgic">Nostalgic – Sentimental reflection</option>
                <option value="bleak">Bleak – Hopeless, desolate</option>
                <option value="majestic">Majestic – Grand and magnificent</option>
                <option value="brooding">Brooding – Deeply thoughtful</option>
            </select>

            <!-- World-Building Detail Slider -->
            <div class="slider-container">
                <label for="world-building">World-Building Detail</label>
                <input type="range" id="world-building" class="slider" min="1" max="5" value="3">
                <div class="values">
                    <span>Minimal World Details</span>
                    <span>Basic Setting Elements</span>
                    <span>Moderate Depth</span>
                    <span>Rich and Layered</span>
                    <span>Highly Intricate World</span>
                </div>
            </div>

            <!-- Story Ending -->
            <label for="story-ending">Story Ending</label>
            <select id="story-ending">
                <option value="">Let Narrately Decide</option>
                <option value="clear-resolution">Clear Resolution</option>
                <option value="open-ended">Open Ended</option>
                <option value="bittersweet">Bittersweet</option>
                <option value="unexpected-twist">Unexpected Twist</option>
                <option value="cliffhanger">Cliffhanger</option>
                <option value="moral-downfall">Moral Downfall</option>
                <option value="unresolved">Unresolved</option>
                <option value="happy">Happy</option>
            </select>
        </div>

        <!-- Create My Story Button -->
        <button id="createStoryButton" onclick="createStory()">
            Create My Story
            <div class="spinner" id="spinner"></div>
        </button>

        <!-- Story Output Section -->
        <div id="storyOutput">
            <!-- Generated story will be displayed here -->
        </div>
    </div> <!-- Close .container -->
    <!-- Start JavaScript section -->
<script>
// Toggle Sections Function
function toggleVisibility(id) {
    const content = document.getElementById(id);
    const toggleSection = content.previousElementSibling;
    const icon = toggleSection.querySelector('.expand-icon');
    if (content.style.display === 'none' || !content.style.display) {
        content.style.display = 'block';
        toggleSection.classList.add('expanded');
    } else {
        content.style.display = 'none';
        toggleSection.classList.remove('expanded');
    }
}

// Initialize toggle content to be hidden by default
document.querySelectorAll('.toggle-content').forEach(function (section) {
    section.style.display = 'none';
});

// Initialize Select2 for multi-select dropdowns
$(document).ready(function() {
    $('#main-story-theme').select2({
        placeholder: "Select Main Story Theme(s)",
        closeOnSelect: false,
        allowClear: true
    });

    $('#sub-story-theme').select2({
        placeholder: "Select Sub Story Theme(s)",
        closeOnSelect: false,
        allowClear: true
    });
});

// Enhanced novel-specific constants
const o1_TOKEN_TARGET = 25000;
const o1_TOKEN_MAX = 25500;
const GENERATION_TIMEOUT = 480000; // 8 minutes
const MIN_CHAPTERS = 10;
const MAX_CHAPTERS = 12;
const MIN_TOKENS = 1000;
const CHUNK_SIZE = 5000; // For text processing

// Token distribution map for validation
const TOKEN_DISTRIBUTION = {
    introduction: { start: 0, target: 4000 },
    risingAction: { start: 4000, target: 6000 },
    climaxBuild: { start: 10000, target: 8000 },
    resolution: { start: 18000, target: 7000 }
};

// Get values from form fields with enhanced error checking
function getValue(id, isSlider = false) {
    const element = document.getElementById(id);
    if (!element) return null;
    
    const value = element.value;
    
    if (!value || value === '' || value === 'Let Narrately Decide') {
        return isSlider ? 3 : null;
    }
    
    return value;
}

// Get default values for empty fields with novel-appropriate defaults
function getDefaultValue(category) {
    const defaults = {
        'narrative-style': 'descriptive',
        'story-perspective': 'third-person-general',
        'audience-type': 'general',
        'main-genre': 'adventure',
        'world-type': 'modern',
        'world-view': 'realistic',
        'time-period': 'modern'
    };
    return defaults[category] || null;
}

// Handle multi-select values with validation
function getMultiSelectValue(id) {
    const values = $(`#${id}`).val();
    return values && values.length > 0 ? values : null;
}

// Enhanced prompt building with validation
function buildPrompt() {
    let prompt = `SYSTEM PRIME DIRECTIVE: You are a precision-engineered novel generation system with advanced context management capabilities. Your directive is to generate a high-quality novel of exactly ${o1_TOKEN_TARGET} tokens while maintaining perfect context and narrative coherence throughout the entire length. Use the included chosen parameters by the user to create the story in accordance with the token target of ${o1_TOKEN_TARGET}.

STRUCTURAL REQUIREMENTS:
1. Divide the novel into ${MIN_CHAPTERS}-${MAX_CHAPTERS} well-structured chapters
2. Begin each chapter with "Chapter X: [Chapter Title]"
3. Maintain consistent narrative threads throughout
4. End each chapter with a clear connection to the next

CONTEXT MANAGEMENT PROTOCOL:
1. Before generating each chapter:
   - Review the overall plot arc
   - Check character continuity
   - Verify setting consistency
   - Ensure thematic coherence
2. During chapter generation:
   - Maintain character voice consistency
   - Track and reference previous events naturally
   - Develop plot points progressively
   - Balance description, dialogue, and action
3. After each chapter:
   - Verify narrative consistency
   - Check for plot holes
   - Ensure character development progression
   - Maintain thematic resonance

TOKEN DISTRIBUTION GUIDELINES:
- Introduction/Setup (Chapters 1-3): ${TOKEN_DISTRIBUTION.introduction.target} tokens
- Rising Action (Chapters 4-6): ${TOKEN_DISTRIBUTION.risingAction.target} tokens
- Climax Build-up (Chapters 7-9): ${TOKEN_DISTRIBUTION.climaxBuild.target} tokens
- Climax and Resolution (Chapters 10-12): ${TOKEN_DISTRIBUTION.resolution.target} tokens\n\n`;

    // Handle basic settings
    const basicSettings = {
        'Narrative Style': getValue('narrative-style') || getDefaultValue('narrative-style'),
        'Story Perspective': getValue('story-perspective') || getDefaultValue('story-perspective'),
        'Audience Type': getValue('audience-type') || getDefaultValue('audience-type'),
        'Main Genre': getValue('main-genre') || getDefaultValue('main-genre'),
        'Sub Genre': getValue('sub-genre'),
        'World Type': getValue('world-type') || getDefaultValue('world-type'),
        'World View': getValue('world-view') || getDefaultValue('world-view'),
        'Time Period': getValue('time-period') || getDefaultValue('time-period')
    };

    prompt += 'NOVEL PARAMETERS:\n';
    for (const [key, value] of Object.entries(basicSettings)) {
        if (value !== null) {
            prompt += `${key}: ${value}\n`;
        }
    }

    // Enhanced character data collection
    function addCharacterData(charNum) {
        const characterData = {
            name: getValue(`char${charNum}-name`),
            gender: getValue(`char${charNum}-gender`),
            age: getValue(`char${charNum}-age`),
            role: getValue(`char${charNum}-role`),
            backstory: getValue(`char${charNum}-backstory`),
            strengths: getValue(`char${charNum}-strengths`),
            weaknesses: getValue(`char${charNum}-weaknesses`),
            personality: getValue(`char${charNum}-personality`),
            morality: getValue(`char${charNum}-morality`, true),
            confidence: getValue(`char${charNum}-confidence`, true),
            decisionMaking: getValue(`char${charNum}-decision-making`, true),
            predictability: getValue(`char${charNum}-predictability`, true),
            relationships: getValue(`char${charNum}-relationships`)
        };

        if (Object.values(characterData).some(value => value !== null)) {
            prompt += `\nCHARACTER ${charNum} PROFILE:\n`;
            for (const [key, value] of Object.entries(characterData)) {
                if (value !== null) {
                    prompt += `${key}: ${value}\n`;
                }
            }
        }
    }

    // Add character data for up to 3 characters
    addCharacterData(1);
    addCharacterData(2);
    addCharacterData(3);

    // Handle advanced settings with improved structure
    const advancedSettings = {
        'Story Plot': getValue('story-plot'),
        'Opening Scene': getValue('opening-scene'),
        'Story Pacing': getValue('story-pacing', true),
        'Plot Complexity': getValue('plot-complexity', true),
        'Plot Predictability': getValue('plot-predictability', true),
        'Main Story Theme': getMultiSelectValue('main-story-theme'),
        'Sub Story Theme': getMultiSelectValue('sub-story-theme'),
        'Additional Characters': getValue('additional-characters', true),
        'Character Growth': getValue('character-growth', true),
        'Dialogue Density': getValue('dialogue-density', true),
        'Emotional Depth': getValue('emotional-depth', true),
        'Mood and Feel': getValue('mood-feel'),
        'World Building': getValue('world-building', true),
        'Tech Advancement': getValue('tech-advancement'),
        'Story Ending': getValue('story-ending')
    };

    if (Object.values(advancedSettings).some(value => value !== null)) {
        prompt += '\nADVANCED NOVEL SETTINGS:\n';
        for (const [key, value] of Object.entries(advancedSettings)) {
            if (value !== null) {
                if (Array.isArray(value)) {
                    prompt += `${key}: ${value.join(', ')}\n`;
                } else {
                    prompt += `${key}: ${value}\n`;
                }
            }
        }
    }

    prompt += `\nQUALITY CONTROL DIRECTIVES:
1. Take your time to plan and structure the complete narrative
2. Focus on quality over speed - utilize the full processing time available
3. Ensure each sentence adds value to the story
4. Maintain consistent pacing throughout
5. Avoid repetition and filler content
6. Keep character motivations and actions consistent
7. Track and resolve all subplot threads

CRITICAL RULES:
1. NEVER rush the ending or lose context
2. NEVER generate filler content to meet token count
3. NEVER introduce plot elements without proper resolution
4. MAINTAIN consistent quality from start to finish
5. ENSURE every chapter advances the story meaningfully\n`;

    return prompt;
}

// Enhanced story validation
function validateStory(story) {
    // Check minimum length
    if (!story || story.length < MIN_TOKENS) {
        throw new Error('Generated story is too short');
    }

    // Validate chapter structure
    const chapters = story.match(/Chapter \d+/g);
    if (!chapters || chapters.length < MIN_CHAPTERS || chapters.length > MAX_CHAPTERS) {
        throw new Error(`Invalid chapter count: ${chapters ? chapters.length : 0}`);
    }

    // Estimate token count (rough approximation)
    const estimatedTokens = story.split(/\s+/).length * 1.3;
    if (estimatedTokens > o1_TOKEN_MAX) {
        throw new Error(`Token limit exceeded: ${Math.floor(estimatedTokens)} tokens generated`);
    }

    return true;
}

// Enhanced text processing for large stories
function processLargeText(text) {
    const chunks = [];
    let index = 0;
    
    while (index < text.length) {
        chunks.push(text.slice(index, index + CHUNK_SIZE));
        index += CHUNK_SIZE;
    }

    return chunks.map(chunk => 
        chunk
            .replace(/Chapter \d+:?\s*([^\n]+)?/g, match => {
                const [chapter, title] = match.split(':').map(s => s.trim());
                return `<h2 class="chapter-title">${chapter}${title ? ': ' + title : ''}</h2>`;
            })
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
    ).join('');
}

// Enhanced story creation function
async function createStory() {
    const createButton = document.getElementById('createStoryButton');
    const spinner = document.getElementById('spinner');
    const storyOutput = document.getElementById('storyOutput');

    if (createButton.disabled) {
        return;
    }

    // Clear any previous content
    storyOutput.innerHTML = `
        <div class="generation-status">
            <p>📝 Initiating story generation...</p>
            <p>⚠️ This process will take several minutes as the AI carefully crafts your story.</p>
            <p>⏳ Please wait while we ensure quality and consistency throughout the novel.</p>
        </div>
    `;
    
    createButton.disabled = true;
    spinner.style.display = 'block';

    try {
        const prompt = buildPrompt();
        const apiUrl = window.location.hostname === 'localhost' 
            ? '/api/generate'
            : `${window.location.origin}/api/generate`;

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), GENERATION_TIMEOUT);

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                prompt,
                maxTokens: o1_TOKEN_MAX,
                targetTokens: o1_TOKEN_TARGET
            }),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Server error: ${response.status}`);
        }

        const data = await response.json();
        
        if (!data.story) {
            throw new Error('No story was generated');
        }

        // Validate story structure and content
        validateStory(data.story);

        // Process large text in chunks
        const formattedStory = processLargeText(data.story);

        storyOutput.innerHTML = `
            <div class="story-container">
                <div class="story-text">
                    ${formattedStory}
                </div>
                <div class="story-actions">
                    <button onclick="copyStory()" class="action-button copy-button">
                        📋 Copy Novel
                    </button>
                    <button onclick="downloadStory()" class="action-button download-button">
                        💾 Download as Text
                    </button>
                </div>
            </div>
        `;

        storyOutput.scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
        console.error('Novel generation error:', error);
        
        let errorMessage = 'An error occurred while generating your novel.';
        if (error.name === 'AbortError') {
            errorMessage = 'The novel generation exceeded the time limit. Please try again.';
        }

        storyOutput.innerHTML = `
            <div class="error-container">
                <p class="error-message">${errorMessage}</p>
                <p class="error-details">${error.message}</p>
                <button onclick="createStory()" class="retry-button">
                    Try Again
                </button>
            </div>
        `;
    } finally {
        createButton.disabled = false;
        spinner.style.display = 'none';
    }
}

// Enhanced copy function with chunked processing
async function copyStory() {
    const storyText = document.querySelector('.story-text').innerText;
    
    try {
        await navigator.clipboard.writeText(storyText);
        const copyButton = document.querySelector('.copy-button');
        copyButton.innerHTML = '✅ Copied!';
        copyButton.style.backgroundColor = '#059669';
        setTimeout(() => {
            copyButton.innerHTML = '📋 Copy Novel';
            copyButton.style.backgroundColor = '#4CAF50';
        }, 2000);
    } catch (err) {
        console.error('Failed to copy novel:', err);
        alert('Unable to copy novel. Please try selecting and copying manually.');
    }
}

// Enhanced download function with streaming
function downloadStory() {
    const storyText = document.querySelector('.story-text').innerText;
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    const filename = `generated-novel-${timestamp}.txt`;

    // Create blob stream
    const stream = new ReadableStream({
        start(controller) {
            const encoder = new TextEncoder();
            const chunks = [];
            let index = 0;
            
            while (index < storyText.length) {
                chunks.push(storyText.slice(index, index + CHUNK_SIZE));
                index += CHUNK_SIZE;
            }

            chunks.forEach(chunk => {
                controller.enqueue(encoder.encode(chunk));
            });
            controller.close();
        }
    });

    new Response(stream)
        .blob()
        .then(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();

            // Cleanup
            setTimeout(() => {
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 1000);

            // Visual feedback
            const downloadButton = document.querySelector('.download-button');
            downloadButton.innerHTML = '✅ Downloaded!';
            downloadButton.style.backgroundColor = '#059669';
            setTimeout(() => {
                downloadButton.innerHTML = '💾 Download as Text';
                downloadButton.style.backgroundColor = '#2C5282';
            }, 2000);
        })
        .catch(error => {
            console.error('Download failed:', error);
            alert('Failed to download the novel. Please try again.');
            
            const downloadButton = document.querySelector('.download-button');
            downloadButton.innerHTML = '❌ Download Failed';
            downloadButton.style.backgroundColor = '#DC2626';
            setTimeout(() => {
                downloadButton.innerHTML = '💾 Download as Text';
                downloadButton.style.backgroundColor = '#2C5282';
            }, 2000);
        });
}
    </script>
</body>
</html>
